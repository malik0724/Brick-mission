<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brick Mission: Pro Fix</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: sans-serif; touch-action: none; color: white; }
        canvas { display: block; background: #000; }
        #top-bar { position: absolute; top: 0; width: 100%; height: 50px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; border-bottom: 1px solid #333; z-index: 10; }
        #stats { position: absolute; top: 55px; width: 100%; text-align: center; color: #888; font-size: 12px; font-weight: bold; z-index: 5; }
        .ui-btn { background: #333; border: 1px solid #444; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .m-btn { width: 180px; padding: 12px; margin: 10px; background: #00d2ff; color: #000; border: none; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="top-bar">
        <button class="ui-btn" onclick="togglePause()">PAUSE</button>
        <div id="mission-tag" style="color:#00d2ff; font-weight:bold;">MISSION 1</div>
        <button class="ui-btn" onclick="timeScale = timeScale === 1 ? 2.5 : 1" id="speed-btn">x1</button>
    </div>
    <div id="stats">BALLS: <span id="bc">20</span></div>
    <div id="overlay"><h1 id="ot">PAUSED</h1><button class="m-btn" onclick="togglePause()">RESUME</button></div>
    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
const bcEl = document.getElementById("bc"), missionEl = document.getElementById("mission-tag"), overlay = document.getElementById("overlay");
const speedBtn = document.getElementById("speed-btn");

let width, height, level = 1, totalBalls = 20, firing = false, isPaused = false, timeScale = 1;
let bricks = [], balls = [], collectibles = [], isAiming = false, startX, startY, endX, endY;
const cols = 8, pad = 4; // Strict 8-column grid

function setup() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    if(bricks.length === 0) spawnRow();
}

function togglePause() { isPaused = !isPaused; overlay.style.display = isPaused ? "flex" : "none"; }

function spawnRow() {
    missionEl.innerText = "MISSION " + level;
    bcEl.innerText = totalBalls;
    bricks.forEach(b => b.row++);
    collectibles.forEach(c => c.row++);
    
    // Game Over Check
    if(bricks.some(b => b.row > 12)) {
        alert("MISSION FAILED! RESTARTING...");
        location.reload();
    }

    const brickSize = (width - (pad * (cols + 1))) / cols;
    const isBossLevel = level % 5 === 0;

    for(let i=0; i<cols; i++) {
        let rnd = Math.random();
        // Regular small bricks only
        if(rnd > 0.45) {
            bricks.push({col: i, row: 1, hp: level * 2, s: brickSize, type: isBossLevel ? 'boss' : 'norm'});
        } else if(rnd > 0.85) {
            collectibles.push({col: i, row: 1, s: brickSize, type: 'add'});
        } else if(rnd > 0.92) {
            bricks.push({col: i, row: 1, s: brickSize, type: 'laser'});
        }
    }
}

window.addEventListener("touchstart", e => { 
    if(!firing && !isPaused) { 
        isAiming = true; 
        startX = e.touches[0].clientX; startY = e.touches[0].clientY; 
        endX = startX; endY = startY;
    }
});

window.addEventListener("touchmove", e => { 
    if(isAiming) { endX = e.touches[0].clientX; endY = e.touches[0].clientY; }
});

window.addEventListener("touchend", () => {
    if(isAiming && startY - endY > 40) fire(Math.atan2(startY - endY, startX - endX));
    isAiming = false;
});

function fire(angle) {
    firing = true; let count = 0;
    const dx = Math.cos(angle) * 10, dy = Math.sin(angle) * 10;
    const itv = setInterval(() => {
        balls.push({x: width/2, y: height-40, dx: -dx, dy: -dy, active: true});
        if(++count >= totalBalls) clearInterval(itv);
    }, 50);
}

function update() {
    if(isPaused) return;
    speedBtn.innerText = "x" + (timeScale === 1 ? "1" : "2.5");
    
    for(let t=0; t<timeScale; t++) {
        balls.forEach(ball => {
            if(!ball.active) return;
            ball.x += ball.dx; ball.y += ball.dy;
            
            // Wall Bounces
            if(ball.x < 4 || ball.x > width-4) ball.dx *= -1;
            if(ball.y < 55) ball.dy *= -1;

            // Brick Logic
            bricks.forEach((b, i) => {
                let bx = b.col * (b.s + pad) + pad, by = b.row * (b.s + pad) + 100;
                if(ball.x > bx && ball.x < bx+b.s && ball.y > by && ball.y < by+b.s) {
                    if(b.type !== 'laser') {
                        if (ball.x < bx + 4 || ball.x > bx + b.s - 4) ball.dx *= -1; else ball.dy *= -1;
                        b.hp--; if(b.hp <= 0) bricks.splice(i, 1);
                    } else {
                        // Horizontal Laser Effect
                        bricks = bricks.filter(other => other.row !== b.row);
                        bricks.splice(i, 1);
                    }
                }
            });

            // Add Ball Powerup
            collectibles.forEach((c, i) => {
                let cx = c.col * (c.s + pad) + pad + c.s/2, cy = c.row * (c.s + pad) + 100 + c.s/2;
                if(Math.hypot(ball.x - cx, ball.y - cy) < 15) {
                    totalBalls++; bcEl.innerText = totalBalls; collectibles.splice(i, 1);
                }
            });

            if (ball.y > height) ball.active = false;
        });
    }
    if(firing && balls.every(b => !b.active)) { balls = []; firing = false; level++; spawnRow(); }
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,width,height);
    
    // Aim Line
    if(isAiming) {
        ctx.beginPath(); ctx.setLineDash([4, 8]); ctx.moveTo(width/2, height-40);
        let angle = Math.atan2(startY - endY, startX - endX);
        ctx.lineTo(width/2 - Math.cos(angle)*600, height-40 - Math.sin(angle)*600);
        ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.stroke(); ctx.setLineDash([]);
    }

    // Bricks
    bricks.forEach(b => {
        let bx = b.col*(b.s+pad)+pad, by = b.row*(b.s+pad)+100;
        ctx.fillStyle = b.type === 'boss' ? '#ff0055' : (b.type === 'laser' ? '#00ff00' : `hsl(${200 + b.hp % 100}, 70%, 50%)`);
        ctx.beginPath(); ctx.roundRect(bx, by, b.s, b.s, 4); ctx.fill();
        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.stroke();
        if(b.type !== 'laser') {
            ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.font = "bold 12px Arial";
            ctx.fillText(b.hp, bx+b.s/2, by+b.s/2+5);
        }
    });

    // Collectibles
    collectibles.forEach(c => {
        let cx = c.col*(c.s+pad)+pad+c.s/2, cy = c.row*(c.s+pad)+100+c.s/2;
        ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.stroke();
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.fill();
    });

    // Balls
    ctx.fillStyle = "#fff"; balls.forEach(b => { if(b.active) { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); }});
    
    // Bottom Shooter
    ctx.fillStyle = "#333"; ctx.beginPath(); ctx.arc(width/2, height-40, 10, 0, Math.PI*2); ctx.fill();

    update(); requestAnimationFrame(draw);
}
window.addEventListener("resize", setup);
setup(); draw();
</script>
</body>
</html>
