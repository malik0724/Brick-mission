<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brick Mission: Ball Blast Sound Edition</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; font-weight: bold; color: #fff; pointer-events: none; z-index: 10; }
        .stat { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid #444; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        .btn { padding: 15px 50px; font-size: 20px; font-weight: bold; border-radius: 40px; border: none; background: #00d2ff; color: #000; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat">BALLS: <span id="ball-count">10</span></div>
        <div class="stat">STAGE: <span id="level-display">1</span></div>
    </div>

    <div id="overlay">
        <h1 id="status">MISSION FAILED</h1>
        <button class="btn" onclick="location.reload()">RETRY MISSION</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const ballEl = document.getElementById("ball-count");
const levelEl = document.getElementById("level-display");
const overlay = document.getElementById("overlay");

let audioCtx, width, height, gameRunning = true;
let bricks = [], balls = [], collectibles = [], level = 1, currentBalls = 10;
let firing = false, isAiming = false, startX, startY, endX, endY;
const rowCount = 10, colCount = 7, brickH = 35;

// --- AUDIO ENGINE ---
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playSFX(freq, type, duration, vol = 0.05) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
}

function init() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    spawnBricks();
}

function spawnBricks() {
    levelEl.innerText = level;
    ballEl.innerText = currentBalls;
    bricks.forEach(b => b.row++);
    collectibles.forEach(c => c.row++);
    
    if (bricks.some(b => b.row >= rowCount - 1)) {
        gameRunning = false;
        overlay.style.display = "flex";
        playSFX(100, 'sawtooth', 0.5); // Game Over Sound
        return;
    }

    const padding = 4;
    const brickW = (width - (padding * (colCount + 1))) / colCount;
    for (let c = 0; c < colCount; c++) {
        if (Math.random() > 0.5) {
            bricks.push({ col: c, row: 1, hp: level * 2, w: brickW, h: brickH, padding: padding });
        } else if (Math.random() > 0.85) {
            collectibles.push({ col: c, row: 1, w: brickW, h: brickH, padding: padding });
        }
    }
}

window.addEventListener("touchstart", e => {
    if (firing || !gameRunning) return;
    initAudio(); // Initialize audio on first touch
    isAiming = true;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
});

window.addEventListener("touchmove", e => {
    if (!isAiming) return;
    endX = e.touches[0].clientX;
    endY = e.touches[0].clientY;
});

window.addEventListener("touchend", () => {
    if (!isAiming) return;
    isAiming = false;
    if (endY < startY - 20) {
        let angle = Math.atan2(startY - endY, startX - endX);
        fireBalls(angle);
    }
});

function fireBalls(angle) {
    firing = true;
    let count = 0;
    const dx = Math.cos(angle) * 9;
    const dy = Math.sin(angle) * 9;
    const timer = setInterval(() => {
        balls.push({ x: width/2, y: height-50, dx: -dx, dy: -dy, active: true });
        playSFX(1200, 'sine', 0.02, 0.02); // Shoot Sound
        count++;
        if (count >= currentBalls) clearInterval(timer);
    }, 60);
}

function update() {
    if (!gameRunning) return;
    balls.forEach(ball => {
        if (!ball.active) return;
        ball.x += ball.dx; ball.y += ball.dy;
        if (ball.x < 5 || ball.x > width-5) { ball.dx *= -1; playSFX(400, 'sine', 0.05); }
        if (ball.y < 80) { ball.dy *= -1; playSFX(400, 'sine', 0.05); }

        bricks.forEach((b, i) => {
            const bx = b.col * (b.w + b.padding) + b.padding;
            const by = b.row * (b.h + b.padding) + 120;
            if (ball.x > bx && ball.x < bx + b.w && ball.y > by && ball.y < by + b.h) {
                ball.dy *= -1; b.hp--;
                playSFX(800 + (b.hp * 2), 'square', 0.03); // Hit Sound
                if (b.hp <= 0) bricks.splice(i, 1);
            }
        });

        collectibles.forEach((c, i) => {
            const cx = c.col * (c.w + c.padding) + c.padding + c.w/2;
            const cy = c.row * (c.h + c.padding) + 120 + c.h/2;
            if (Math.hypot(ball.x - cx, ball.y - cy) < 15) {
                currentBalls++; collectibles.splice(i, 1);
                playSFX(1500, 'sine', 0.2, 0.1); // Collect Sound
            }
        });
        if (ball.y > height) ball.active = false;
    });

    if (firing && balls.every(b => !b.active)) {
        balls = []; firing = false; level++; spawnBricks();
    }
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,width,height);
    if (isAiming) {
        ctx.setLineDash([5, 10]); ctx.beginPath(); ctx.moveTo(width/2, height-50);
        let angle = Math.atan2(startY - endY, startX - endX);
        ctx.lineTo(width/2 - Math.cos(angle)*400, height-50 - Math.sin(angle)*400);
        ctx.strokeStyle = "#fff"; ctx.stroke();
    }
    bricks.forEach(b => {
        const bx = b.col * (b.w + b.padding) + b.padding;
        const by = b.row * (b.h + b.padding) + 120;
        ctx.fillStyle = `hsl(${280 + (b.hp % 60)}, 70%, 50%)`;
        ctx.beginPath(); ctx.roundRect(bx, by, b.w, b.h, 6); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.textAlign = "center";
        ctx.font = "bold 14px Arial"; ctx.fillText(b.hp, bx + b.w/2, by + b.h/2 + 5);
    });
    collectibles.forEach(c => {
        const cx = c.col * (c.w + c.padding) + c.padding + c.w/2;
        const cy = c.row * (c.h + c.padding) + 120 + c.h/2;
        ctx.fillStyle = "#0f0"; ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
    });
    ctx.fillStyle = "#fff";
    balls.forEach(b => { if (b.active) { ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill(); } });
    update(); requestAnimationFrame(draw);
}
init(); draw();
</script>
</body>
</html>
